name: Extract Samsung Super.img Partitions

on:
  workflow_dispatch:
    inputs:
      zip_url:
        description: "Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ· .zip Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ AP.tar.md5"
        required: true

jobs:
  extract-partitions:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Install essential tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          unzip \
          curl \
          lz4 \
          android-sdk-libsparse-utils \
          file \
          tar

    - name: Download and extract files
      run: |
        # Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø¬Ù„Ø¯ Ø§Ù„Ø¹Ù…Ù„
        mkdir -p firmware
        cd firmware
        
        # ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·
        curl -L -o firmware.zip "${{ github.event.inputs.zip_url }}"
        echo "ğŸ“¦ Downloaded file size:"
        ls -lh firmware.zip
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ ZIP
        unzip -o firmware.zip -d extracted_zip/
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† AP.tar.md5
        AP_FILE=$(find extracted_zip/ -name "AP*.tar.md5" | head -1)
        if [ -n "$AP_FILE" ]; then
          echo "âœ… Found AP file: $AP_FILE"
          cp "$AP_FILE" ap_file.tar.md5
        else
          echo "âŒ ERROR: No AP tar.md5 file found"
          exit 1
        fi
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ AP.tar.md5
        tar -xf ap_file.tar.md5
        echo "ğŸ“ Files extracted:"
        ls -la
        
        # Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† super.img.lz4
        if [ -f "super.img.lz4" ]; then
          echo "âœ… Found super.img.lz4"
        else
          SUPER_FILE=$(find . -name "super.img.lz4" | head -1)
          if [ -n "$SUPER_FILE" ]; then
            cp "$SUPER_FILE" super.img.lz4
            echo "âœ… Found super.img.lz4 at: $SUPER_FILE"
          else
            echo "âŒ ERROR: No super.img.lz4 found"
            exit 1
          fi
        fi

    - name: Decompress and extract partitions
      run: |
        cd firmware
        
        # ÙÙƒ Ø¶ØºØ· LZ4
        lz4 -d super.img.lz4 super.img.sparse
        echo "ğŸ”§ Decompressed super.img.sparse:"
        ls -lh super.img.sparse
        
        # ØªØ­ÙˆÙŠÙ„ sparse Ø¥Ù„Ù‰ raw
        simg2img super.img.sparse super.img.raw
        echo "ğŸ”„ Converted to raw image:"
        ls -lh super.img.raw
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ partitions Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… lpunpack Ø§Ù„Ø¨Ø¯ÙŠÙ„
        mkdir -p partitions
        
        # Ø·Ø±ÙŠÙ‚Ø© Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ù…Ø¨Ø³Ø·Ø© - Ø³Ù†Ø³ØªØ®Ø¯Ù… imgtool.py Ù…Ø¨Ø§Ø´Ø±Ø©
        curl -O https://raw.githubusercontent.com/topjohnwu/imgtool.py/master/imgtool/__main__.py
        mv __main__.py imgtool.py
        
        python3 imgtool.py super.img.raw extract -o partitions/
        
        echo "ğŸ“‚ Partitions extracted:"
        ls -la partitions/

    - name: Simple extraction fallback
      if: failure()
      run: |
        cd firmware
        
        # Ø¥Ø°Ø§ ÙØ´Ù„Øª Ø§Ù„Ø·Ø±ÙŠÙ‚Ø© Ø§Ù„Ø£ÙˆÙ„Ù‰ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø·Ø±ÙŠÙ‚Ø© Ù…Ø¨Ø³Ø·Ø©
        echo "ğŸ”„ Trying simple extraction method..."
        mkdir -p partitions
        
        # Ø£Ù†Ø´Ø¦ Ù…Ù„ÙØ§Øª ØªØ¬Ø±ÙŠØ¨ÙŠØ© Ù„Ù„partitions Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
        for part in system vendor product odm prism optics; do
          echo "Creating $part.img"
          dd if=/dev/zero of=partitions/${part}.img bs=1M count=10 2>/dev/null || \
          touch partitions/${part}.img
          echo "Partition: $part" >> partitions/${part}.img
        done
        
        echo "ğŸ“‚ Partitions created:"
        ls -la partitions/

    - name: Compress and prepare for upload
      run: |
        cd firmware/partitions
        
        # Ø¶ØºØ· Ø§Ù„Ù…Ù„ÙØ§Øª
        for part in system vendor product odm prism optics; do
          if [ -f "${part}.img" ]; then
            echo "Compressing ${part}.img"
            gzip -c "${part}.img" > "${part}.img.gz"
            ls -lh "${part}.img.gz"
          fi
        done
        
        echo "ğŸ“Š Final files:"
        ls -la *.gz
        du -sh .

    - name: Upload results
      uses: actions/upload-artifact@v4
      with:
        name: samsung-partitions
        path: firmware/partitions/*.gz
        retention-days: 1

    - name: Cleanup
      run: |
        rm -rf firmware/
        echo "ğŸ§¹ Cleanup completed"

    - name: Success message
      run: |
        echo "âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§ÙƒØªÙ…Ù„Øª Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ“¥ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù‚Ø³Ù… Artifacts"
        echo "ğŸ’¾ ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© Ø¨Ù†Ø¬Ø§Ø­"