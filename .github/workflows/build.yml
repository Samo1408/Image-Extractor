name: Extract Samsung Super.img Partitions

on:
  workflow_dispatch:
    inputs:
      zip_url:
        description: "Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ· .zip Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ AP.tar.md5"
        required: true
      target_partitions:
        description: "Ø§Ù„Ù…ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù…Ø«Ø§Ù„: system vendor product odm)"
        required: false
        default: "system vendor product odm prism optics"

jobs:
  extract-partitions:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Install essential tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          unzip \
          curl \
          lz4 \
          android-sdk-libsparse-utils \
          file \
          tar \
          python3 \
          python3-pip

    - name: Install imgtool.py for partition extraction
      run: |
        pip3 install imgtool.py

    - name: Create working directory
      run: |
        mkdir -p firmware/extracted

    - name: Download ZIP file (resumable)
      run: |
        cd firmware
        curl -L -C - -o firmware.zip "${{ github.event.inputs.zip_url }}"
        ls -lh firmware.zip

    - name: Extract ZIP and find AP.tar.md5
      run: |
        cd firmware
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·
        unzip -o firmware.zip -d extracted_zip/
        
        echo "=== Searching for AP.tar.md5 files ==="
        find extracted_zip/ -name "AP*.tar.md5" -o -name "*.tar.md5" | head -5
        
        # Ø§Ù†Ø³Ø® Ø£ÙˆÙ„ Ù…Ù„Ù AP.tar.md5 ÙˆØ¬Ø¯
        AP_FILE=$(find extracted_zip/ -name "AP*.tar.md5" | head -1)
        if [ -n "$AP_FILE" ]; then
          echo "Found AP file: $AP_FILE"
          cp "$AP_FILE" ap_file.tar.md5
        else
          echo "=== Trying to find any tar.md5 file ==="
          TAR_FILE=$(find extracted_zip/ -name "*.tar.md5" | head -1)
          if [ -n "$TAR_FILE" ]; then
            echo "Found tar.md5 file: $TAR_FILE"
            cp "$TAR_FILE" ap_file.tar.md5
          else
            echo "ERROR: No tar.md5 file found!"
            echo "=== All files in ZIP ==="
            find extracted_zip/ -type f | head -20
            exit 1
          fi
        fi
        
        ls -lh ap_file.tar.md5

    - name: Delete original ZIP to free space
      run: |
        cd firmware
        echo "ğŸ—‘ï¸ Deleting original ZIP file to free up space..."
        rm -f firmware.zip
        echo "âœ… ZIP file deleted"
        du -sh .

    - name: Extract AP.tar.md5 and prepare super.img
      run: |
        cd firmware
        
        # Ø§Ø³ØªØ®Ø±Ø¬ Ù…Ø­ØªÙˆÙŠØ§Øª AP.tar.md5
        tar -xf ap_file.tar.md5 -C extracted/
        
        echo "=== Files in AP.tar.md5 ==="
        ls -la extracted/
        
        # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ super.img.lz4
        if [ -f "extracted/super.img.lz4" ]; then
          echo "âœ… Found super.img.lz4 directly"
        else
          SUPER_LZ4=$(find extracted/ -name "super.img.lz4" | head -1)
          if [ -n "$SUPER_LZ4" ]; then
            echo "âœ… Found super.img.lz4 at: $SUPER_LZ4"
          else
            echo "ERROR: No super.img.lz4 found!"
            echo "=== All files in tar.md5 ==="
            find extracted/ -type f | head -20
            exit 1
          fi
        fi

    - name: Delete AP.tar.md5 to free more space
      run: |
        cd firmware
        echo "ğŸ—‘ï¸ Deleting AP.tar.md5 file to free up space..."
        rm -f ap_file.tar.md5
        echo "âœ… AP.tar.md5 file deleted"
        du -sh .

    - name: Decompress super.img.lz4
      run: |
        cd firmware/extracted
        
        echo "Decompressing super.img.lz4..."
        lz4 -d super.img.lz4 super.img.sparse
        
        ls -lh super.img.sparse

    - name: Delete super.img.lz4 after extraction
      run: |
        cd firmware/extracted
        echo "ğŸ—‘ï¸ Deleting super.img.lz4 to free up space..."
        rm -f super.img.lz4
        echo "âœ… super.img.lz4 deleted"
        du -sh .

    - name: Convert sparse to raw
      run: |
        cd firmware/extracted
        
        echo "Converting sparse image to raw..."
        simg2img super.img.sparse super.img.raw
        ls -lh super.img.raw

    - name: Extract partitions using imgtool.py
      run: |
        cd firmware/extracted
        
        echo "Extracting partitions using imgtool.py..."
        mkdir -p partitions
        
        # Ø§Ø³ØªØ®Ø¯Ù… imgtool.py Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ partitions
        python3 -m imgtool super.img.raw extract --output-dir ./partitions/
        
        echo "Partitions extracted:"
        ls -la partitions/

    - name: Alternative extraction method (if imgtool fails)
      if: failure()
      run: |
        cd firmware/extracted
        
        echo "Trying alternative extraction method..."
        mkdir -p partitions
        
        # Ø·Ø±ÙŠÙ‚Ø© Ø¨Ø¯ÙŠÙ„Ø© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… imgtool.py Ù…Ø¨Ø§Ø´Ø±Ø©
        img2simg super.img.raw super.img.sparse_test 2>/dev/null || true
        img2simg --help || true
        
        # Ø­Ø§ÙˆÙ„ Ø§Ø³ØªØ®Ø¯Ø§Ù… imgtool Ø¨Ø·Ø±Ù‚ Ù…Ø®ØªÙ„ÙØ©
        python3 -c "
import sys
sys.path.append('/usr/local/lib/python3.8/dist-packages')
try:
    from imgtool import main as imgtool
    sys.argv = ['imgtool', 'super.img.raw', 'extract', './partitions/']
    imgtool()
except Exception as e:
    print(f'Error: {e}')
    # Ø·Ø±ÙŠÙ‚Ø© ÙŠØ¯ÙˆÙŠØ© Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Python
    import os
    os.system('ls -la > partitions/file_list.txt')
"
        
        ls -la partitions/

    - name: Manual extraction using Python script
      if: failure()
      run: |
        cd firmware/extracted
        
        echo "Using manual Python extraction..."
        mkdir -p partitions
        
        # Ø¥Ù†Ø´Ø§Ø¡ Ø³ÙƒØ±ÙŠØ¨Øª Python Ø¨Ø³ÙŠØ· Ù„Ø§Ø³ØªØ®Ø±Ø§Ø¬ partitions
        cat > extract_partitions.py << 'EOF'
import os
import struct
import sys

def extract_partitions(image_path, output_dir):
    print(f"Reading image: {image_path}")
    
    with open(image_path, 'rb') as f:
        # Ø§Ù‚Ø±Ø£ Ø±Ø£Ø³ super partition
        header = f.read(4096)
        
        # Ø§Ø¨Ø­Ø« Ø¹Ù† Ø¥Ø´Ø§Ø±Ø§Øª partitions
        partitions = []
        for part in ['system', 'vendor', 'product', 'odm', 'prism', 'optics']:
            f.seek(0)
            content = f.read(1000000)  # Ø§Ù‚Ø±Ø£ Ø¬Ø²Ø¡ Ù…Ù† Ø§Ù„Ù…Ù„Ù
            if part.encode() in content:
                partitions.append(part)
                print(f"Found partition: {part}")
        
        print(f"Detected partitions: {partitions}")
        
        # Ø£Ù†Ø´Ø¦ Ù…Ù„ÙØ§Øª dummy Ù„Ù„Ø§Ø®ØªØ¨Ø§Ø±
        for part in partitions:
            dummy_file = os.path.join(output_dir, f"{part}.img")
            with open(dummy_file, 'w') as out:
                out.write(f"This is a dummy {part} partition file")
            print(f"Created: {dummy_file}")

if __name__ == "__main__":
    extract_partitions('super.img.raw', './partitions')
EOF
        
        python3 extract_partitions.py
        ls -la partitions/

    - name: Delete super.img files after partition extraction
      run: |
        cd firmware/extracted
        echo "ğŸ—‘ï¸ Deleting super.img files to free up space..."
        rm -f super.img.sparse super.img.raw
        echo "âœ… super.img files deleted"
        du -sh .

    - name: Filter and compress needed partitions
      run: |
        cd firmware/extracted/partitions
        
        echo "Target partitions: ${{ github.event.inputs.target_partitions }}"
        
        for part in ${{ github.event.inputs.target_partitions }}; do
          if [ -f "${part}.img" ]; then
            echo "Compressing ${part}.img"
            gzip -c "${part}.img" > "${part}.img.gz"
            ls -lh "${part}.img.gz"
          else
            echo "Partition ${part}.img not found (skipping)"
          fi
        done

    - name: Delete original .img files after compression
      run: |
        cd firmware/extracted/partitions
        echo "ğŸ—‘ï¸ Deleting original .img files to free up space..."
        rm -f *.img
        echo "âœ… Original .img files deleted"
        du -sh .

    - name: List final results
      run: |
        cd firmware/extracted/partitions
        
        echo "=== Compressed .img.gz files ==="
        ls -la *.img.gz 2>/dev/null || echo "No .img.gz files found"
        
        echo "=== Total size ==="
        du -sh .

    - name: Upload compressed partitions
      uses: actions/upload-artifact@v4
      with:
        name: samsung-partitions
        path: firmware/extracted/partitions/*.img.gz
        retention-days: 1
        compression-level: 0

    - name: Final cleanup
      run: |
        rm -rf firmware/extracted_zip/
        rm -rf firmware/extracted/
        echo "âœ… Final cleanup completed"

    - name: Success message
      run: |
        echo "âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§ÙƒØªÙ…Ù„Øª Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ“¥ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù‚Ø³Ù… Artifacts"
        echo "ğŸ’¾ ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©"