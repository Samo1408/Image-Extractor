name: Extract Samsung Super.img Partitions

on:
  workflow_dispatch:
    inputs:
      zip_url:
        description: "Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ· .zip Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ AP.tar.md5"
        required: true
      target_partitions:
        description: "Ø§Ù„Ù…ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù…Ø«Ø§Ù„: system vendor product odm)"
        required: false
        default: "system vendor product odm prism optics"

jobs:
  extract-partitions:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Install essential tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          unzip \
          curl \
          lz4 \
          android-sdk-libsparse-utils \
          file \
          tar

    - name: Create working directory
      run: |
        mkdir -p firmware/extracted

    - name: Download ZIP file
      run: |
        cd firmware
        curl -L -o firmware.zip "${{ github.event.inputs.zip_url }}"
        ls -lh firmware.zip

    - name: Extract ZIP and find AP.tar.md5
      run: |
        cd firmware
        unzip -o firmware.zip -d extracted_zip/
        
        AP_FILE=$(find extracted_zip/ -name "AP*.tar.md5" | head -1)
        if [ -n "$AP_FILE" ]; then
          cp "$AP_FILE" ap_file.tar.md5
          echo "Found AP file: $AP_FILE"
        else
          echo "ERROR: No AP tar.md5 file found"
          exit 1
        fi
        ls -lh ap_file.tar.md5

    - name: Delete original ZIP to free space
      run: |
        cd firmware
        rm -f firmware.zip
        echo "ZIP file deleted"
        du -sh .

    - name: Extract AP.tar.md5
      run: |
        cd firmware
        tar -xf ap_file.tar.md5 -C extracted/
        echo "Files in AP.tar.md5:"
        ls -la extracted/

    - name: Delete AP.tar.md5 to free space
      run: |
        cd firmware
        rm -f ap_file.tar.md5
        echo "AP.tar.md5 file deleted"
        du -sh .

    - name: Decompress super.img.lz4
      run: |
        cd firmware/extracted
        lz4 -d super.img.lz4 super.img
        ls -lh super.img

    - name: Delete super.img.lz4 after extraction
      run: |
        cd firmware/extracted
        rm -f super.img.lz4
        echo "super.img.lz4 deleted"
        du -sh .

    - name: Install imgtool for partition extraction
      run: |
        sudo apt-get install -y python3-pip
        pip3 install git+https://github.com/topjohnwu/imgtool.py

    - name: Extract partitions using imgtool
      run: |
        cd firmware/extracted
        mkdir -p partitions
        python3 -m imgtool super.img extract -o partitions/
        echo "Partitions extracted:"
        ls -la partitions/

    - name: Delete super.img after extraction
      run: |
        cd firmware/extracted
        rm -f super.img
        echo "super.img deleted"
        du -sh .

    - name: Compress needed partitions
      run: |
        cd firmware/extracted/partitions
        for part in ${{ github.event.inputs.target_partitions }}; do
          if [ -f "${part}.img" ]; then
            echo "Compressing ${part}.img"
            gzip -c "${part}.img" > "${part}.img.gz"
            ls -lh "${part}.img.gz"
          else
            echo "Partition ${part}.img not found"
          fi
        done

    - name: Delete original partition files
      run: |
        cd firmware/extracted/partitions
        rm -f *.img
        echo "Original partition files deleted"
        du -sh .

    - name: List final results
      run: |
        cd firmware/extracted/partitions
        echo "Compressed files:"
        ls -la *.img.gz
        du -sh .

    - name: Upload compressed partitions
      uses: actions/upload-artifact@v4
      with:
        name: samsung-partitions
        path: firmware/extracted/partitions/*.img.gz
        retention-days: 1

    - name: Final cleanup
      run: |
        rm -rf firmware/
        echo "Final cleanup completed"

    - name: Success message
      run: |
        echo "âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§ÙƒØªÙ…Ù„Øª Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ“¥ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù‚Ø³Ù… Artifacts"