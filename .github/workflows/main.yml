name: Extract Samsung Super.img Partitions

on:
  workflow_dispatch:
    inputs:
      zip_url:
        description: "Ø±Ø§Ø¨Ø· Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ· .zip Ø§Ù„Ø°ÙŠ ÙŠØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ AP.tar.md5"
        required: true
      target_partitions:
        description: "Ø§Ù„Ù…ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© (Ù…Ø«Ø§Ù„: system vendor product odm)"
        required: false
        default: "system vendor product odm prism optics"

jobs:
  extract-partitions:
    runs-on: ubuntu-latest
    timeout-minutes: 120
    
    steps:
    - name: Install essential tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          unzip \
          curl \
          lz4 \
          android-sdk-libsparse-utils \
          file \
          tar

    - name: Create working directory
      run: |
        mkdir -p firmware/extracted

    - name: Download ZIP file (resumable)
      run: |
        cd firmware
        curl -L -C - -o firmware.zip "${{ github.event.inputs.zip_url }}"
        ls -lh firmware.zip

    - name: Extract ZIP and find AP.tar.md5
      run: |
        cd firmware
        
        # Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…Ù„Ù Ø§Ù„Ù…Ø¶ØºÙˆØ·
        unzip -o firmware.zip -d extracted_zip/
        
        echo "=== Searching for AP.tar.md5 files ==="
        find extracted_zip/ -name "AP*.tar.md5" -o -name "*.tar.md5" | head -5
        
        # Ø§Ù†Ø³Ø® Ø£ÙˆÙ„ Ù…Ù„Ù AP.tar.md5 ÙˆØ¬Ø¯
        AP_FILE=$(find extracted_zip/ -name "AP*.tar.md5" | head -1)
        if [ -n "$AP_FILE" ]; then
          echo "Found AP file: $AP_FILE"
          cp "$AP_FILE" ap_file.tar.md5
        else
          echo "=== Trying to find any tar.md5 file ==="
          TAR_FILE=$(find extracted_zip/ -name "*.tar.md5" | head -1)
          if [ -n "$TAR_FILE" ]; then
            echo "Found tar.md5 file: $TAR_FILE"
            cp "$TAR_FILE" ap_file.tar.md5
          else
            echo "ERROR: No tar.md5 file found!"
            echo "=== All files in ZIP ==="
            find extracted_zip/ -type f | head -20
            exit 1
          fi
        fi
        
        ls -lh ap_file.tar.md5

    - name: Delete original ZIP to free space
      run: |
        cd firmware
        echo "ğŸ—‘ï¸ Deleting original ZIP file to free up space..."
        rm -f firmware.zip
        echo "âœ… ZIP file deleted"
        du -sh .

    - name: Extract AP.tar.md5 and prepare super.img
      run: |
        cd firmware
        
        # Ø§Ø³ØªØ®Ø±Ø¬ Ù…Ø­ØªÙˆÙŠØ§Øª AP.tar.md5
        tar -xf ap_file.tar.md5 -C extracted/
        
        echo "=== Files in AP.tar.md5 ==="
        ls -la extracted/
        
        # ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ super.img.lz4
        if [ -f "extracted/super.img.lz4" ]; then
          echo "âœ… Found super.img.lz4 directly"
        else
          SUPER_LZ4=$(find extracted/ -name "super.img.lz4" | head -1)
          if [ -n "$SUPER_LZ4" ]; then
            echo "âœ… Found super.img.lz4 at: $SUPER_LZ4"
          else
            echo "ERROR: No super.img.lz4 found!"
            echo "=== All files in tar.md5 ==="
            find extracted/ -type f | head -20
            exit 1
          fi
        fi

    - name: Delete AP.tar.md5 to free more space
      run: |
        cd firmware
        echo "ğŸ—‘ï¸ Deleting AP.tar.md5 file to free up space..."
        rm -f ap_file.tar.md5
        echo "âœ… AP.tar.md5 file deleted"
        du -sh .

    - name: Decompress super.img.lz4
      run: |
        cd firmware/extracted
        
        echo "Decompressing super.img.lz4..."
        lz4 -d super.img.lz4 super.img.sparse
        
        ls -lh super.img.sparse

    - name: Delete super.img.lz4 after extraction
      run: |
        cd firmware/extracted
        echo "ğŸ—‘ï¸ Deleting super.img.lz4 to free up space..."
        rm -f super.img.lz4
        echo "âœ… super.img.lz4 deleted"
        du -sh .

    - name: Convert sparse to raw and extract partitions
      run: |
        cd firmware/extracted
        
        echo "Converting sparse image to raw..."
        simg2img super.img.sparse super.img.raw
        
        echo "Extracting partitions..."
        mkdir -p partitions
        lpunpack super.img.raw partitions/
        
        echo "Partitions extracted:"
        ls -la partitions/

    - name: Delete super.img files after partition extraction
      run: |
        cd firmware/extracted
        echo "ğŸ—‘ï¸ Deleting super.img files to free up space..."
        rm -f super.img.sparse super.img.raw
        echo "âœ… super.img files deleted"
        du -sh .

    - name: Filter and compress needed partitions
      run: |
        cd firmware/extracted/partitions
        
        echo "Target partitions: ${{ github.event.inputs.target_partitions }}"
        
        for part in ${{ github.event.inputs.target_partitions }}; do
          if [ -f "${part}.img" ]; then
            echo "Compressing ${part}.img"
            gzip -c "${part}.img" > "${part}.img.gz"
            ls -lh "${part}.img.gz"
          else
            echo "Partition ${part}.img not found (skipping)"
          fi
        done

    - name: Delete original .img files after compression
      run: |
        cd firmware/extracted/partitions
        echo "ğŸ—‘ï¸ Deleting original .img files to free up space..."
        rm -f *.img
        echo "âœ… Original .img files deleted"
        du -sh .

    - name: List final results
      run: |
        cd firmware/extracted/partitions
        
        echo "=== Compressed .img.gz files ==="
        ls -la *.img.gz 2>/dev/null || echo "No .img.gz files found"
        
        echo "=== Total size ==="
        du -sh .

    - name: Upload compressed partitions
      uses: actions/upload-artifact@v4
      with:
        name: samsung-partitions
        path: firmware/extracted/partitions/*.img.gz
        retention-days: 1
        compression-level: 0

    - name: Final cleanup
      run: |
        rm -rf firmware/extracted_zip/
        rm -rf firmware/extracted/
        echo "âœ… Final cleanup completed"

    - name: Success message
      run: |
        echo "âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§ÙƒØªÙ…Ù„Øª Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ“¥ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù‚Ø³Ù… Artifacts"
        echo "ğŸ’¾ ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ© Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ù…Ø³Ø§Ø­Ø©"
        echo "ğŸ”½ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø£Ù‚Ù„ Ø¨ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ"        fi

    - name: Handle super.img extraction
      run: |
        cd firmware/extracted
        
        if [ -f "super.img.lz4" ]; then
          echo "Decompressing LZ4 file..."
          lz4 -d super.img.lz4 super.img.sparse
        elif [ -f "super.img" ]; then
          echo "Using super.img directly..."
          cp super.img super.img.sparse
        fi
        
        ls -lh super.img.sparse

    - name: Convert sparse to raw and extract partitions
      run: |
        cd firmware/extracted
        
        echo "Converting sparse image to raw..."
        simg2img super.img.sparse super.img.raw
        
        echo "Extracting partitions..."
        mkdir -p partitions
        lpunpack super.img.raw partitions/
        
        echo "Partitions extracted:"
        ls -la partitions/

    - name: Filter and compress needed partitions
      run: |
        cd firmware/extracted/partitions
        
        echo "Target partitions: ${{ github.event.inputs.target_partitions }}"
        
        for part in ${{ github.event.inputs.target_partitions }}; do
          if [ -f "${part}.img" ]; then
            echo "Compressing ${part}.img"
            gzip -c "${part}.img" > "${part}.img.gz"
            ls -lh "${part}.img.gz"
          else
            echo "Partition ${part}.img not found (skipping)"
          fi
        done

    - name: List final results
      run: |
        cd firmware/extracted/partitions
        
        echo "=== All available .img files ==="
        ls -la *.img 2>/dev/null || echo "No .img files found"
        
        echo "=== Compressed .img.gz files ==="
        ls -la *.img.gz 2>/dev/null || echo "No .img.gz files found"
        
        echo "=== Total size ==="
        du -sh .

    - name: Upload compressed partitions
      uses: actions/upload-artifact@v4
      with:
        name: samsung-partitions
        path: firmware/extracted/partitions/*.img.gz
        retention-days: 1
        compression-level: 0

    - name: Cleanup to save space
      run: |
        rm -rf firmware/extracted_zip/
        rm -rf firmware/extracted/
        rm -rf firmware/ap_file.tar.md5
        rm -rf firmware/firmware.zip
        echo "Cleanup completed"

    - name: Success message
      run: |
        echo "âœ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø§ÙƒØªÙ…Ù„Øª Ø¨Ù†Ø¬Ø§Ø­!"
        echo "ğŸ“¥ ÙŠÙ…ÙƒÙ†Ùƒ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù…Ù„ÙØ§Øª Ù…Ù† Ù‚Ø³Ù… Artifacts"
        echo "ğŸ’¾ ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„Ù…ÙØ§Øª Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø© ÙÙ‚Ø·"
        echo "ğŸ”½ Ø§Ù„Ø­Ø¬Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ Ø£Ù‚Ù„ Ø¨ÙƒØ«ÙŠØ± Ù…Ù† Ø§Ù„Ù…Ù„Ù Ø§Ù„Ø£ØµÙ„ÙŠ"
