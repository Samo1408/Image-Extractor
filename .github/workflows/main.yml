name: Extract Samsung Super.img Partitions

on:
  workflow_dispatch:
    inputs:
      ap_url:
        description: "رابط ملف AP مباشر من السحابة"
        required: true
      target_partitions:
        description: "المفات المطلوبة (مثال: system vendor product odm)"
        required: false
        default: "system vendor product odm prism optics"

jobs:
  extract-partitions:
    runs-on: ubuntu-latest
    timeout-minutes: 90
    
    steps:
    - name: Install essential tools
      run: |
        sudo apt-get update
        sudo apt-get install -y \
          p7zip-full \
          curl \
          lz4 \
          android-sdk-libsparse-utils

    - name: Create working directory
      run: |
        mkdir -p firmware/extracted

    - name: Download AP file (resumable)
      run: |
        cd firmware
        curl -L -C - -o ap_file.zip "${{ github.event.inputs.ap_url }}"
        ls -lh ap_file.zip

    - name: Extract super.img.lz4 from AP archive
      run: |
        cd firmware
        7z x ap_file.zip -oextracted/ "super.img.lz4" -r
        ls -la extracted/

    - name: Decompress LZ4 and convert sparse to raw
      run: |
        cd firmware/extracted
        lz4 -d super.img.lz4 super.img.sparse
        simg2img super.img.sparse super.img.raw
        ls -lh *.img*

    - name: Extract partitions using lpunpack
      run: |
        cd firmware/extracted
        mkdir -p partitions
        lpunpack super.img.raw partitions/
        ls -la partitions/

    - name: Filter and compress only needed partitions
      run: |
        cd firmware/extracted/partitions
        for part in ${{ github.event.inputs.target_partitions }}; do
          if [ -f "${part}.img" ]; then
            echo "Compressing ${part}.img"
            gzip -c "${part}.img" > "${part}.img.gz"
            ls -lh "${part}.img.gz"
          else
            echo "Partition ${part}.img not found"
          fi
        done

    - name: List available partitions
      run: |
        cd firmware/extracted/partitions
        echo "=== Available partitions ==="
        ls -la *.img || echo "No .img files found"
        echo "=== Compressed files ==="
        ls -la *.img.gz || echo "No .img.gz files found"

    - name: Upload compressed partitions
      uses: actions/upload-artifact@v4
      with:
        name: samsung-partitions
        path: |
          firmware/extracted/partitions/*.img.gz
        retention-days: 1
        compression-level: 0

    - name: Cleanup to save space
      run: |
        rm -rf firmware/extracted/super.img.*
        rm -rf firmware/ap_file.zip
        du -sh firmware/

    - name: Show final result
      run: |
        echo "=== Extraction completed successfully ==="
        echo "Download partitions from the Artifacts section above"
